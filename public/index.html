<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Simple 1-to-1 Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    #app { max-width: 720px; margin: 0 auto; }
    .hidden { display: none; }
    .messages { border: 1px solid #ddd; height: 50vh; overflow-y: auto; padding: 0.5rem; margin-bottom: 0.5rem; }
    .msg { margin: 0.3rem 0; padding: 0.4rem; border-radius: 6px; }
    .me { background: #e6f7ff; align-self: flex-end; }
    .other { background: #f3f3f3; }
    .meta { font-size: 0.8rem; color: #666; }
    .controls { display: flex; gap: .5rem; }
    .controls input[type="text"] { flex: 1; padding: .5rem; }
    .typing { font-size: 0.9rem; color: #444; margin-bottom: .4rem; }
  </style>
</head>
<body>
  <div id="app">
    <h2>1-to-1 Chat</h2>

    <div id="join-area">
      <label>
        Your name: <input id="username" type="text" placeholder="Alice" />
      </label>
      <label style="margin-left:1rem">
        Room id: <input id="roomId" type="text" placeholder="room123" />
      </label>
      <button id="joinBtn">Join Room</button>
      <p style="font-size:.9rem;color:#555">Open the same URL in another tab/window and join the same room id.</p>
    </div>

    <div id="chat-area" class="hidden">
      <div class="meta">Room: <span id="roomLabel"></span> — Participants: <span id="participantsCount">0</span></div>
      <div id="typing" class="typing hidden"></div>
      <div id="messages" class="messages"></div>

      <form id="sendForm" class="controls" autocomplete="off">
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <button type="submit">Send</button>
      </form>
      <button id="leaveBtn" style="margin-top:.5rem">Leave Room</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // client-side script
    const socket = io();

    // UI refs
    const joinArea = document.getElementById('join-area');
    const chatArea = document.getElementById('chat-area');
    const usernameInput = document.getElementById('username');
    const roomInput = document.getElementById('roomId');
    const joinBtn = document.getElementById('joinBtn');
    const messagesEl = document.getElementById('messages');
    const sendForm = document.getElementById('sendForm');
    const messageInput = document.getElementById('messageInput');
    const roomLabel = document.getElementById('roomLabel');
    const participantsCountEl = document.getElementById('participantsCount');
    const typingEl = document.getElementById('typing');
    const leaveBtn = document.getElementById('leaveBtn');

    let localUsername = '';
    let localRoom = '';
    let typingTimer = null;
    let isTyping = false;

    function appendMessage({ text, from, id, ts }) {
      const me = id === socket.id;
      const div = document.createElement('div');
      div.className = 'msg ' + (me ? 'me' : 'other');
      div.innerHTML = `<strong>${escapeHtml(from)}</strong> <span class="meta">· ${new Date(ts).toLocaleTimeString()}</span>
                       <div>${escapeHtml(text)}</div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    joinBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      const roomId = roomInput.value.trim();
      if (!username || !roomId) {
        alert('Please enter both name and room id');
        return;
      }
      socket.emit('join-room', { roomId, username }, (res) => {
        if (!res || !res.ok) {
          alert('Failed to join room: ' + (res && res.error ? res.error : 'Unknown'));
          return;
        }
        localUsername = username;
        localRoom = roomId;
        roomLabel.textContent = roomId;
        participantsCountEl.textContent = res.participants || '1';
        joinArea.classList.add('hidden');
        chatArea.classList.remove('hidden');
        messageInput.focus();
      });
    });

    sendForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      socket.emit('send-message', { text }, (ack) => {
        if (ack && ack.ok) {
          messageInput.value = '';
          stopTyping();
        } else {
          console.warn('message send failed', ack);
        }
      });
    });

    // Typing indicator: notify server when user types
    messageInput.addEventListener('input', () => {
      if (!isTyping) {
        isTyping = true;
        socket.emit('typing', { isTyping: true });
      }
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        stopTyping();
      }, 700); // after 700ms of inactivity, stop typing
    });

    function stopTyping() {
      if (isTyping) {
        isTyping = false;
        socket.emit('typing', { isTyping: false });
      }
    }

    // Handle socket events
    socket.on('message', (payload) => {
      appendMessage(payload);
    });

    socket.on('peer-joined', ({ username }) => {
      const div = document.createElement('div');
      div.className = 'msg other';
      div.innerHTML = `<em>${escapeHtml(username)} joined the room.</em>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    socket.on('peer-left', ({ username }) => {
      const div = document.createElement('div');
      div.className = 'msg other';
      div.innerHTML = `<em>${escapeHtml(username)} left the room.</em>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    socket.on('room-info', ({ participants }) => {
      participantsCountEl.textContent = participants;
    });

    socket.on('peer-typing', ({ username, isTyping }) => {
      if (isTyping) {
        typingEl.textContent = `${username} is typing...`;
        typingEl.classList.remove('hidden');
      } else {
        typingEl.classList.add('hidden');
      }
    });

    leaveBtn.addEventListener('click', () => {
      if (localRoom) {
        socket.emit('typing', { isTyping: false });
        socket.disconnect();
        // simply reload to reset UI and reconnect
        setTimeout(() => location.reload(), 200);
      }
    });

    // Optional: reconnect behavior
    socket.io.on('reconnect', () => {
      // If you'd like, implement automatic rejoin logic here.
      // For this simple example we leave manual reload behavior.
    });
  </script>
</body>
</html>
